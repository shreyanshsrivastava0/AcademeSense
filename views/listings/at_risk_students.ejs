<% layout("layouts/dashboard.ejs") %>

<style>
.at-risk-page {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
    padding: 20px;
}
.page-header {
    background: linear-gradient(135deg, #ff6b6b 0%, #e74c3c 100%);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
}
.student-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    transition: transform 0.3s ease;
    cursor: pointer;
}
.student-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.15);
}
.risk-high { border-left: 5px solid #e74c3c; }
.risk-medium { border-left: 5px solid #f39c12; }
.risk-low { border-left: 5px solid #27ae60; }
.student-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 15px;
}
.student-name {
    font-size: 1.3rem;
    font-weight: bold;
    margin: 0;
}
.student-id {
    color: #6c757d;
    font-size: 0.9rem;
}
.risk-badge {
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: bold;
    text-transform: uppercase;
}
.performance-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}
.metric-item {
    text-align: center;
    background: #f8f9fa;
    padding: 15px;
    border-radius: 10px;
}
.metric-value {
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 5px;
}
.metric-label {
    font-size: 0.8rem;
    color: #6c757d;
    text-transform: uppercase;
}
.insights-section {
    border-top: 1px solid #dee2e6;
    padding-top: 15px;
    margin-top: 15px;
}
.insight-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}
.insight-tag {
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 0.8rem;
}
.weakness-tag {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
.strength-tag {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}
.back-btn {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    border: none;
    padding: 12px 25px;
    border-radius: 25px;
    color: white;
    text-decoration: none;
    transition: all 0.3s ease;
    display: inline-block;
}
.back-btn:hover {
    transform: translateY(-2px);
    color: white;
    text-decoration: none;
}
.stats-summary {
    background: white;
    padding: 25px;
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}
.stat-item {
    text-align: center;
    padding: 20px;
    border-radius: 10px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}
.stat-number {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 10px;
}
.email-actions {
    background: white;
    padding: 20px;
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}
.btn-send-alerts {
    background: linear-gradient(135deg, #ff6b6b 0%, #e74c3c 100%);
    border: none;
    padding: 12px 25px;
    border-radius: 25px;
    color: white;
    transition: all 0.3s ease;
}
.btn-send-alerts:hover {
    transform: translateY(-2px);
    color: white;
    box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
}
</style>

<div class="at-risk-page">
    <div class="page-header text-center">
        <h1>üö® At-Risk Students</h1>
        <p class="mb-0">Students requiring immediate attention and support</p>
    </div>

    <div class="row mb-3">
        <div class="col">
            <a href="javascript:history.back()" class="back-btn">‚Üê Back to Dashboard</a>
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="stats-summary">
        <h3>üìä Summary Statistics</h3>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-number text-danger">
                    <%= students.filter(s => s.risk_level === 'high').length %>
                </div>
                <div class="stat-label">High Risk</div>
            </div>
            <div class="stat-item">
                <div class="stat-number text-warning">
                    <%= students.filter(s => s.risk_level === 'medium').length %>
                </div>
                <div class="stat-label">Medium Risk</div>
            </div>
            <div class="stat-item">
                <div class="stat-number text-info">
                    <%= students.filter(s => s.email).length %>
                </div>
                <div class="stat-label">With Email</div>
            </div>
            <div class="stat-item">
                <div class="stat-number text-primary">
                    <%= students.length %>
                </div>
                <div class="stat-label">Total At-Risk</div>
            </div>
        </div>
    </div>

    <!-- Email Actions -->
    <div class="email-actions">
        <h4>üìß Bulk Actions</h4>
        <div class="row align-items-center">
            <div class="col-md-6">
                <input type="email" id="teacherEmail" class="form-control" placeholder="Teacher Email (optional)">
            </div>
            <div class="col-md-3">
                <button id="sendBulkAlerts" class="btn btn-send-alerts w-100">
                    Send Risk Alerts to All
                </button>
            </div>
            <div class="col-md-3">
                <div class="text-muted small">
                    Will send to students with valid email addresses
                </div>
            </div>
        </div>
        <div id="emailStatus" class="mt-3"></div>
    </div>

    <!-- Student Cards -->
    <% if (students && students.length > 0) { %>
        <div class="row">
            <% students.forEach(student => { %>
                <div class="col-md-6 col-lg-4">
                    <div class="student-card risk-<%= student.risk_level %>" onclick="viewStudent('<%= student.student_id %>')">
                        <div class="student-header d-flex justify-content-between align-items-start">
                            <div>
                                <h4 class="student-name"><%= student.name %></h4>
                                <p class="student-id">ID: <%= student.student_id %></p>
                                <% if (student.email) { %>
                                    <p class="student-id">üìß <%= student.email %></p>
                                <% } %>
                            </div>
                            <span class="risk-badge bg-<%= student.risk_level === 'high' ? 'danger' : 'warning' %>">
                                <%= student.risk_level.toUpperCase() %>
                            </span>
                        </div>

                        <div class="performance-metrics">
                            <div class="metric-item">
                                <div class="metric-value text-<%= student.overall_performance >= 75 ? 'success' : 'danger' %>">
                                    <%= student.overall_performance ? student.overall_performance.toFixed(1) + '%' : 'N/A' %>
                                </div>
                                <div class="metric-label">Performance</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value text-<%= student.attendance >= 85 ? 'success' : 'danger' %>">
                                    <%= student.attendance || 'N/A' %>%
                                </div>
                                <div class="metric-label">Attendance</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value text-<%= student.study_hours >= 5 ? 'success' : 'danger' %>">
                                    <%= student.study_hours || 'N/A' %>h
                                </div>
                                <div class="metric-label">Study Hours</div>
                            </div>
                        </div>

                        <% if (student.performance_insights) { %>
                        <div class="insights-section">
                            <div class="mb-2">
                                <strong>Key Issues:</strong>
                            </div>
                            <div class="insight-tags">
                                <% if (student.performance_insights.weaknesses) { %>
                                    <% student.performance_insights.weaknesses.slice(0, 3).forEach(weakness => { %>
                                        <span class="insight-tag weakness-tag"><%= weakness %></span>
                                    <% }) %>
                                <% } %>
                            </div>
                            
                            <% if (student.performance_insights.strengths && student.performance_insights.strengths.length > 0) { %>
                            <div class="mt-2">
                                <strong>Strengths:</strong>
                            </div>
                            <div class="insight-tags">
                                <% student.performance_insights.strengths.slice(0, 2).forEach(strength => { %>
                                    <span class="insight-tag strength-tag"><%= strength %></span>
                                <% }) %>
                            </div>
                            <% } %>
                        </div>
                        <% } %>

                        <!-- ML Prediction -->
                        <% if (student.ml_prediction) { %>
                        <div class="mt-2 text-center">
                            <small class="text-muted">
                                AI Prediction: <strong><%= student.ml_prediction.toFixed(1) %></strong>
                            </small>
                        </div>
                        <% } %>

                        <!-- Last Alert -->
                        <% if (student.alerts_sent && student.alerts_sent.length > 0) { %>
                        <div class="mt-2 text-center">
                            <small class="text-success">
                                Last alert: <%= new Date(student.alerts_sent[student.alerts_sent.length - 1].sent_at).toLocaleDateString() %>
                            </small>
                        </div>
                        <% } %>
                    </div>
                </div>
            <% }) %>
        </div>
    <% } else { %>
        <div class="text-center py-5">
            <div class="mb-4">
                <i class="fas fa-user-check" style="font-size: 4rem; color: #28a745;"></i>
            </div>
            <h3>No At-Risk Students Found</h3>
            <p class="text-muted">Great news! Currently no students are identified as being at risk.</p>
            <a href="/" class="back-btn">‚Üê Back to Dashboard</a>
        </div>
    <% } %>
</div>

<script>
function viewStudent(studentId) {
    window.location.href = `/student/${studentId}`;
}

// Bulk email functionality
document.getElementById('sendBulkAlerts').addEventListener('click', async function() {
    const button = this;
    const originalText = button.textContent;
    button.textContent = 'Sending...';
    button.disabled = true;
    
    try {
        const teacherEmail = document.getElementById('teacherEmail').value;
        const response = await fetch('/api/send-risk-alerts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ teacherEmail })
        });
        
        const result = await response.json();
        const statusDiv = document.getElementById('emailStatus');
        
        if (result.success) {
            statusDiv.innerHTML = `<div class="alert alert-success">
                <strong>Success!</strong> ${result.message}
                <br><small>Check the results below for individual email status.</small>
            </div>`;
            
            // Show detailed results if available
            if (result.results && result.results.length > 0) {
                const successCount = result.results.filter(r => r.success).length;
                const failureCount = result.results.filter(r => !r.success).length;
                
                statusDiv.innerHTML += `
                    <div class="mt-2">
                        <small class="text-success">‚úÖ Successful: ${successCount}</small> | 
                        <small class="text-danger">‚ùå Failed: ${failureCount}</small>
                    </div>
                `;
            }
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger">
                <strong>Error:</strong> ${result.error}
            </div>`;
        }
    } catch (error) {
        document.getElementById('emailStatus').innerHTML = `<div class="alert alert-danger">
            <strong>Error:</strong> ${error.message}
        </div>`;
    } finally {
        button.textContent = originalText;
        button.disabled = false;
    }
});
</script>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">